{% extends 'base_bootstrap_css.html' %}

{% block js_script_top %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.js" integrity="sha512-d6nObkPJgV791iTGuBoVC9Aa2iecqzJRE0Jiqvk85BhLHAPhWqkuBiQb1xz2jvuHNqHLYoN3ymPfpiB1o+Zgpw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock %}


{% block body %}
    <div class="container p-5 my-5 bg-primary text-white">
        <h5>{{ page_vars['h2_text'] }}</h5>


    </div>

    <div class="container">
        <div class="chart_title">
            <h5>Historic of complains</h5>
        </div>
        <canvas id="chart_histo"  width="400" height="400"></canvas>

    </div>


{% endblock %}


{% block js_script_bottom %}


<script src="{{ url_for('static', filename='js/misc_libs/date_handlers.js') }}" type="text/javascript"></script>

<script>
    var chart_canvas_id = document.getElementById("chart_histo");
    var chart_histo;
    
    const json_dataset = {{ page_vars['json_dataset']|safe }};


    
    // function gets x_values and y_values
    let {x_values, y_values} = setChartDataset(json_dataset['data'], 'post_datetime', 'hp_post_id');
    console.log(x_values);
    console.log(y_values);
    
    function setChartDataset(chart_data, x_key, y_keys){
        // delete if previous chart if any
        if (chart_histo!=undefined | chart_histo!=null) {
            chart_histo.destroy();
        }
        
        // https://css-tricks.com/the-many-ways-of-getting-data-into-charts/
        // declare variables
        let x_values = [];
        let y_values = [];
        
        // set values
        $.each(chart_data, function(index, data_rows) {
            // Loop through datset and find x and y
            $.each(data_rows, function(index, col) {
                // set x values
                if (index==x_key){
                    x_values.push(timestamp_to_date(col));
                }
                // set y values, shoul devolved to a groupby=> list of y_keys
                if (index==y_keys){
                    y_values.push(col);
                }               
            });
            
        });

        return {x_values, y_values};

    }

    // create chatr config
    chart_config = createChatConfig(x_values, y_values, "Testing the chaty");
    console.log("chart config:");
    console.log(chart_config);

    function createChatConfig(x_labels, dataset_values, chart_title){
        const chart_config = {
            labels: x_labels,
            datasets: [{
                label: chart_title,
                data: dataset_values,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(255, 159, 64, 0.2)',
                    'rgba(255, 205, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(201, 203, 207, 0.2)'
                ],
                borderColor: [
                    'rgb(255, 99, 132)',
                    'rgb(255, 159, 64)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(54, 162, 235)',
                    'rgb(153, 102, 255)',
                    'rgb(201, 203, 207)'
                ],
                borderWidth: 1
            }]
        };
          return chart_config;
    };


</script>
{% endblock %}


