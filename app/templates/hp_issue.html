{% extends 'base_bootstrap_css.html' %}

{% block js_script_top %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.js" integrity="sha512-d6nObkPJgV791iTGuBoVC9Aa2iecqzJRE0Jiqvk85BhLHAPhWqkuBiQb1xz2jvuHNqHLYoN3ymPfpiB1o+Zgpw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock %}


{% block body %}
    <div class="container p-5 my-5 bg-primary text-white">
        <h5>{{ page_vars['h2_text'] }}</h5>


    </div>

    <div class="container">
        <div class="chart_title">
            <h5>Historic of complains</h5>
        </div>
        <div>
            <canvas id="chart_histo"  width="100%" height="30%"></canvas>
        </div>
        

    </div>


{% endblock %}


{% block js_script_bottom %}


<script src="{{ url_for('static', filename='js/misc_libs/date_handlers.js') }}" type="text/javascript"></script>

<script>
    var chart_canvas_id = document.getElementById("chart_histo");
    var chart_histo;
    
    const json_dataset = {{ page_vars['json_dataset']|safe }};


    // Group incidents by day
    groupHistoPerPeriod(json_dataset['data'], 'post_date_time', 'post_id', 'd');
    function groupHistoPerPeriod(json_data, x_key, y_key_to_count,periodOfTime){



    }



    // function gets x_values and y_values
    let {x_values, y_values} = setChartDataset(json_dataset['data'], 'post_datetime', 'hp_post_id');
    console.log(x_values);
    console.log(y_values);
    
    function setChartDataset(chart_data, x_key, y_keys){
        // delete if previous chart if any
        if (chart_histo!=undefined | chart_histo!=null) {
            chart_histo.destroy();
        }
        
        // https://css-tricks.com/the-many-ways-of-getting-data-into-charts/
        // declare variables
        let x_values = [];
        let y_values = [];
        
        // set values
        $.each(chart_data, function(index, data_rows) {
            // Loop through datset and find x and y
            $.each(data_rows, function(index, col) {
                // set x values
                if (index==x_key){
                    x_values.push(timestamp_to_date(col));
                }
                // set y values, shoul devolved to a groupby=> list of y_keys
                if (index==y_keys){
                    y_values.push(col);
                }               
            });
            
        });

        return {x_values, y_values};

    }

        
    createChart(chart_canvas_id, x_values, y_values, 'Title of the chart');


    function createChart(canvas_id, x_values, y_values, chart_title){
        const chart_graph = new Chart(canvas_id, {
            type: 'bar',
            data: {
                labels: x_values,
                datasets: [{
                    label: chart_title,
                    //barPercentage: 0.5,
                    //barThickness: 6,
                    //maxBarThickness: 8,
                    minBarLength: 200,
                    data: y_values
                }]
            },

        }
        )
        
    }


    

</script>
{% endblock %}


